---
import MarketingLayout from '../layouts/MarketingLayout.astro';

const token = Astro.url.searchParams.get('token');
const API_URL = import.meta.env.PUBLIC_API_URL || 'https://api.floimg.com';
---

<MarketingLayout title="Reset Password">
  <div class="min-h-[70vh] flex items-center justify-center px-6 py-16">
    <div class="w-full max-w-md">
      {!token ? (
        <div class="text-center">
          <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-red-100 dark:bg-red-900/30 mb-6">
            <svg class="w-8 h-8 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <h1 class="text-2xl font-bold text-zinc-900 dark:text-white mb-2">Invalid Reset Link</h1>
          <p class="text-zinc-600 dark:text-zinc-400 mb-6">
            This password reset link is invalid or has expired.
          </p>
          <a href="/forgot-password" class="inline-block rounded-lg bg-violet-600 px-6 py-3 font-medium text-white hover:bg-violet-500 transition-colors">
            Request new link
          </a>
        </div>
      ) : (
        <>
          <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-zinc-900 dark:text-white">Set new password</h1>
            <p class="mt-2 text-zinc-600 dark:text-zinc-400">
              Enter your new password below
            </p>
          </div>

          <form id="reset-form" class="space-y-4">
            <div>
              <label for="password" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">
                New password
              </label>
              <input
                type="password"
                id="password"
                name="password"
                required
                minlength="8"
                autocomplete="new-password"
                class="mt-1 block w-full rounded-lg border border-zinc-300 dark:border-white/20 bg-white dark:bg-zinc-900 px-4 py-3 text-zinc-900 dark:text-white placeholder-zinc-400 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 focus:outline-none transition-colors"
                placeholder="At least 8 characters"
              />
            </div>

            <div>
              <label for="confirm-password" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">
                Confirm new password
              </label>
              <input
                type="password"
                id="confirm-password"
                name="confirm-password"
                required
                minlength="8"
                autocomplete="new-password"
                class="mt-1 block w-full rounded-lg border border-zinc-300 dark:border-white/20 bg-white dark:bg-zinc-900 px-4 py-3 text-zinc-900 dark:text-white placeholder-zinc-400 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/20 focus:outline-none transition-colors"
                placeholder="Confirm your password"
              />
            </div>

            <input type="hidden" name="token" value={token} />

            <button
              type="submit"
              id="submit-btn"
              class="w-full rounded-lg bg-violet-600 px-4 py-3 font-medium text-white hover:bg-violet-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Reset password
            </button>

            <div id="message" class="hidden text-center p-4 rounded-lg text-sm"></div>
          </form>
        </>
      )}
    </div>
  </div>
</MarketingLayout>

<script define:vars={{ API_URL }}>
  const form = document.getElementById('reset-form');
  if (form) {
    const message = document.getElementById('message');
    const button = document.getElementById('submit-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      button.disabled = true;
      button.textContent = 'Resetting...';
      message.classList.add('hidden');

      const formData = new FormData(form);
      const password = formData.get('password');
      const confirmPassword = formData.get('confirm-password');
      const token = formData.get('token');

      if (password !== confirmPassword) {
        message.className = 'text-center p-4 rounded-lg text-sm bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200';
        message.textContent = 'Passwords do not match';
        message.classList.remove('hidden');
        button.disabled = false;
        button.textContent = 'Reset password';
        return;
      }

      try {
        const res = await fetch(`${API_URL}/api/auth/reset-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password }),
        });

        const data = await res.json();

        if (res.ok) {
          message.className = 'text-center p-4 rounded-lg text-sm bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200';
          message.innerHTML = '<strong>Password reset!</strong><br>Redirecting to login...';
          message.classList.remove('hidden');
          setTimeout(() => {
            window.location.href = '/login';
          }, 2000);
        } else {
          throw new Error(data.error || 'Failed to reset password');
        }
      } catch (error) {
        message.className = 'text-center p-4 rounded-lg text-sm bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200';
        message.textContent = error.message || 'Something went wrong';
        message.classList.remove('hidden');
        button.disabled = false;
        button.textContent = 'Reset password';
      }
    });
  }
</script>
